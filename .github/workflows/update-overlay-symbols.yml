name: Update Overlay Symbols

# Regenerate the overlay symbol whitelist whenever overlay DTS files change.
# If the list changes, commit and push the updated file automatically.

on:
  push:
    branches: [ main ]
    paths:
      - 'devicetree-overlays/*-overlay.dts'
      - 'scripts/extract-overlay-symbols.sh'
  pull_request:
    branches: [ main ]
    paths:
      - 'devicetree-overlays/*-overlay.dts'
      - 'scripts/extract-overlay-symbols.sh'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  update-symbols:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        # Full checkout so we can push commits back
        ref: ${{ github.head_ref || github.ref_name }}
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: Install dependencies
      run: sudo apt-get update && sudo apt-get install -y perl coreutils

    - name: Generate overlay symbol whitelist
      run: make overlay-symbols

    - name: Check for changes
      id: diff
      run: |
        if git diff --quiet devicetree-overlays/overlay-symbols.txt; then
          echo "changed=false" >> "$GITHUB_OUTPUT"
          echo "overlay-symbols.txt is already up to date"
        else
          echo "changed=true" >> "$GITHUB_OUTPUT"
          echo "overlay-symbols.txt needs updating"
          git diff devicetree-overlays/overlay-symbols.txt
        fi

    # Only commit on push to main (not on PRs â€“ let the PR check fail instead
    # so the contributor can see what needs updating).
    - name: Commit updated symbols
      if: steps.diff.outputs.changed == 'true' && github.event_name == 'push'
      run: |
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"
        git add devicetree-overlays/overlay-symbols.txt
        git commit -m "chore: auto-update overlay symbol whitelist

        Regenerated by scripts/extract-overlay-symbols.sh from the
        current set of devicetree-overlays/*-overlay.dts files."
        git push

    # On PRs, fail if the symbols file is stale so the contributor knows
    # to run `make overlay-symbols` and commit the result.
    - name: Verify symbols are up to date (PR check)
      if: github.event_name == 'pull_request'
      run: |
        if [ "${{ steps.diff.outputs.changed }}" = "true" ]; then
          echo "::error::devicetree-overlays/overlay-symbols.txt is out of date."
          echo "Run 'make overlay-symbols' and commit the result."
          exit 1
        fi
